name: Update Flashcards Data

on:
  push:
    branches:
      - main
    paths:
      - 'flashcards/**/*.pdf'

permissions:
  contents: write
  actions: write

jobs:
  regenerate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CARTES_PAT || github.token }}

      - name: Warn if PAT is missing
        run: |
          if [ -z "${{ secrets.CARTES_PAT }}" ]; then
            echo "::warning::Missing CARTES_PAT secret. Pushes will use GITHUB_TOKEN and will not trigger other workflows."
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pymupdf pillow numpy

      - name: Collect touched PDFs
        id: detect
        run: |
          set -euo pipefail
          before="${{ github.event.before }}"
          after="${{ github.sha }}"

          if [ -z "$before" ] || [ "$before" = "0000000000000000000000000000000000000000" ]; then
            before="$(git rev-list --max-parents=0 HEAD)"
          fi

          files=$(
            git diff --name-only "$before" "$after" -- ":(glob)flashcards/**/*.pdf" \
              | sed '/^$/d' \
              | sort -u
          )

          if [ -z "${files}" ]; then
            echo "any=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          printf "%s\n" "${files}" > changed_pdfs.txt
          {
            echo "any=true"
            echo "list<<EOF"
            printf "%s\n" "${files}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Regenerate flashcards assets
        if: steps.detect.outputs.any == 'true'
        run: |
          python - <<'PY'
          import subprocess
          import sys
          from pathlib import Path

          changed_file = Path("changed_pdfs.txt")
          entries = [line.strip() for line in changed_file.read_text().splitlines() if line.strip()]
          if not entries:
              print("No changed PDFs to process.", file=sys.stderr)
              sys.exit(0)

          for rel_path in entries:
              pdf_path = Path(rel_path)
              if not pdf_path.exists():
                  print(f"::warning::Skipping missing {pdf_path}")
                  continue

              search_dir = pdf_path.parent
              print(f"Processing {pdf_path}")
              subprocess.run(
                  [
                      sys.executable,
                      "cartes.py",
                      "--search-dir",
                      str(search_dir),
                      "--pdf",
                      pdf_path.name,
                  ],
                  check=True,
              )
          PY

      - name: Commit and push updates
        id: commit_push
        if: steps.detect.outputs.any == 'true'
        run: |
          git add flashcards
          if git diff --cached --quiet; then
            echo "No changes produced by cartes.py"
            echo "pushed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update flashcards assets"

          if [ -n "${{ secrets.CARTES_PAT }}" ]; then
            git remote set-url origin "https://x-access-token:${{ secrets.CARTES_PAT }}@github.com/${{ github.repository }}.git"
          fi

          git push origin "HEAD:${{ github.ref_name }}"
          echo "pushed=true" >> "$GITHUB_OUTPUT"

      - name: Trigger deploy workflow when PAT is missing
        if: steps.detect.outputs.any == 'true' && steps.commit_push.outputs.pushed == 'true'
        env:
          CARTES_PAT: ${{ secrets.CARTES_PAT }}
        run: |
          if [ -n "$CARTES_PAT" ]; then
            echo "CARTES_PAT is set; skipping manual deploy dispatch."
            exit 0
          fi

          curl -sS -X POST \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy-dist.yml/dispatches" \
            -d '{"ref":"main"}'
